### redis主从同步：

**主从同步分为 2 个步骤：同步和命令传播**

* 同步：将从服务器的数据库状态更新成主服务器当前的数据库状态。
* 命令传播：当主服务器数据库状态被修改后，导致主从服务器数据库状态不一致，此时需要让主从数据同步到一致的过程。
#### 同步：

从服务器对主服务的同步操作，需要通过 sync 命令来实现，以下是 sync 命令的执行步骤：

* 从服务器向主服务器发送 sync 命令
* 收到 sync 命令后，主服务器执行 bgsave 命令，用来生成 rdb 文件，并在一个缓冲区中记录从现在开始执行的写命令。
* bgsave 执行完成后，将生成的 rdb 文件发送给从服务器，用来给从服务器更新数据
* 主服务器再将缓冲区记录的写命令发送给从服务器，从服务器执行完这些写命令后，此时的数据库状态便和主服务器一致了。

![图片](https://uploader.shimo.im/f/YfBg60K8fvFotfpL.png!thumbnail)

### 
### psync 具有完整重同步和部分重同步两种模式（2,8版本后）：

**完整重同步：**用于初次复制情况，执行过程同 sync，在这不赘述了。

**部分重同步：**用于断线后重复制情况，如果满足一定条件，主服务器只需要将断线期间执行的写命令发送给从服务器即可。

#### 部分重同步功能由以下 3 部分组成：

* 主从服务器的复制偏移量
* 主服务器的复制积压缓冲区
* 服务器的运行 id（run id）
#### 复制偏移量:

* 执行复制的主从服务器都会分别维护各自的复制偏移量：
* 主服务器每次向从服务器传播 n 个字节数据时，都会将自己的复制偏移量加 n。从服务器接受主服务器传来的数据时，也会将自己的复制偏移量加 n
#### 复制积压缓冲区:

当从服务器向主服务器发送 psync 命令时，还需要将自己的复制偏移量带上，主服务器就可以通过这个复制偏移量和复制积压缓冲区的偏移量进行对比。

若复制积压缓冲区存在从服务器的复制偏移量 + 1 后的数据，则进行部分重同步，否则进行完整重同步。

#### run id:

运行 id 是在进行初次复制时，主服务器将会将自己的运行 id 发送给从服务器，让其保存起来。

当从服务器断线重连后，从服务器会将这个运行 id 发送给刚连接上的主服务器。

若当前服务器的运行 id 与之相同，说明从服务器断线前复制的服务器就是当前服务器，主服务器可以尝试执行部分同步；若不同则说明从服务器断线前复制的服务器不是当前服务器，主服务器直接执行完整重同步。

### 总结：

发送 SLAVEOF 命令可以进行主从同步，比如：SLAVEOF 127.0.0.6379

#### 主从同步有同步和命令传播 2 个步骤：

* 同步：将从服务器的数据库状态更新成主服务器当前的数据库状态（一个消耗资源的操作）
* 命令传播：当主服务器数据库状态被修改后，导致主从服务器数据库状态不一致，此时需要让主从数据同步到一致的过程
# **主从同步分初次复制和断线后重复制两种情况 ：**
* 2.8 版本开始，在出现断线后重复制情况时，主服务器会根据复制偏移量、复制积压缓冲区和 run id，来确定执行完整重同步还是部分重同步
* 2.8 版本使用 psync 命令来代替 sync 命令去执行同步操作。目的是为了解决同步（sync 命令）的低效操作
### 主从复制存在的问题：

1. **主节点** 的 **写能力** 受到 **单机的限制**。 
2.  **主节点** 的 **存储能力** 受到 **单机的限制**。 
3.  **原生复制** 的弊端在早期的版本中也会比较突出，比如：`Redis` **复制中断** 后，**从节点** 会发起 `psync`。此时如果 **同步不成功**，则会进行 **全量同步**，**主库** 执行 **全量备份** 的同时，可能会造成毫秒或秒级的 **卡顿**。


