### 什么是Redis持久化？

持久化就是把内存的数据写到磁盘中去，防止服务宕机了内存数据丢失。

### redis 持久化有哪几种方式，优缺点，怎么选？

#### redis 持久化的两种方式（RDB、AOF）：

**RDB快照持久化：**是对 redis 中的数据执行周期性的持久化。该文件是一个压缩过的二进制文件。

**自动间隔触发：**

* save 900 1  当时间到900秒时，如果至少有1个key发生变化，就会自动触发bgsave命令创建快照
* save 300 10  当时间到300秒时，如果至少有10个key发生变化，就会自动触发bgsave命令创建快照 
* save 60 10000    当时间到60秒时，如果至少有10000个key发生变化，就会自动触发bgsave命令创建快照

**AOF持久化：**

AOF持久化是通过保存Redis服务器所执行的写命令来记录数据库状态的。会把被执行的写命令写到AOF文件的末尾，记录数据的变化。

**AOF的实现：**

AOF需要记录Redis的每个写命令，步骤为：命令追加（append）、文件写入（write）和文件同步（sync）

**AOF重写【机制】（保存最后一次数据的修改）：**

为了解决AOF文件体积膨胀的问题。

AOF文件重写并不需要对现有的AOF文件进行任何读取、分享和写入操作，而是通过读取服务器当前的数据库状态来实现的。

#### RDB和AOF优缺点：

**RDB：**

优点：

    * RDB快照是一个压缩过的非常紧凑的文件，保存着某个时间点的数据集，适合做数据的备份，灾难恢复。
    * 可以最大化Redis的性能，在保存RDB文件，服务器进程只需fork一个子进程来完成RDB文件的创建，父进程不需要做IO操作。
    * 与AOF相比，恢复大数据集的时候会更快。

缺点：

    * RDB的数据安全性是不如AOF的，保存整个数据集的过程是比繁重的，根据配置可能要几分钟才快照一次，如果服务器宕机，那么就可能丢失几分钟的数据。
    * Redis数据集较大时，子进程要完成快照会比较耗CPU、耗时。

**AOF：**

优点：

    * 数据更完整，安全性更高，秒级数据丢失（取决fsync策略，如果是everysec，最多丢失1秒的数据）。
    * AOF文件是一个只进行追加的日志文件，且写入操作是以Redis协议的格式保存的，内容是可读的，适合误删紧急恢复。

缺点：

    * 对于相同的数据集，AOF文件的体积要大于RDB文件，数据恢复也会比较慢。
#### RDB 和 AOF 到底该如何选择：

redis 支持同时开启两种持久化方式。用 AOF 来保证数据不丢失，作为数据恢复的第一选择; 用 RDB 来做不同程度的冷备（冷备份是数据库正常关闭，会提供一份完整数据库文件，使用此文件恢复数据），在 AOF 文件都丢失或损坏不可用的时候，还可以使用 RDB 来进行快速的数据恢复。



